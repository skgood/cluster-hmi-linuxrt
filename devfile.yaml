schemaVersion: 2.1.0
metadata:
  name: cluster-hmi-linuxrt-main
components:
  - container:
      env:
        - name: PLUGIN_REMOTE_ENDPOINT_EXECUTABLE
          value: /remote-endpoint/plugin-remote-endpoint
        - name: THEIA_PLUGINS
          value: 'local-dir:///plugins/sidecars/universal-developer-image'
        - name: CHE_DASHBOARD_URL
          value: 'https://192.168.49.2.nip.io'
        - name: CHE_PLUGIN_REGISTRY_URL
          value: 'https://192.168.49.2.nip.io/plugin-registry/v3'
        - name: CHE_PLUGIN_REGISTRY_INTERNAL_URL
          value: 'http://plugin-registry.eclipse-che.svc:8080/v3'
        - name: OPENVSX_REGISTRY_URL
          value: 'https://open-vsx.org'
      image: 'quay.io/devfile/universal-developer-image:ubi8-38da5c2'
      memoryLimit: 2Gi
      sourceMapping: /projects
    name: universal-developer-image
  - container:
      args:
        - sh
        - '-c'
        - tail -f /dev/null  
      image: 'artifactory-mb.harman.com:5036/aebt/cluster_hmi_build_docker:0.1'
      memoryLimit: 4Gi
      sourceMapping: /projects
    name: cluster-build-image
commands:
  - exec:
      commandLine: /bin/bash
      component: cluster-build-image
      workingDir: ${PROJECT_SOURCE}
    id: cluster-app-shell
  - exec:
      commandLine: ./rpm_compile.sh && echo "\e[32mDone.\e[0m cluster-build-image"
      component: cluster-build-image
      workingDir: ${PROJECT_SOURCE}
    id: build-cluster-app
  - exec:
      commandLine: 'scp -P ${input:port} ${input:path}${input:file} ${input:user}@${input:host}:/home/${input:user} && ssh -p ${input:port} ${input:user}@${input:host} rpm -Uvh --force --nodeps ${input:file} && echo Install rpm done, restarting app && ssh -p ${input:port} ${input:user}@${input:host} systemctl restart hmi && echo -e "\e[32mDone.\e[0m instant-deploy"'
      component: universal-developer-image
      workingDir: '${PROJECT_SOURCE}'
    id: instant-deploy
  - exec:
      commandLine: './makeUniquePathByDateAndSend.sh && echo -e "\e[32mDone.\e[0m upload-cluster-app"'
      component: universal-developer-image
      workingDir: '${PROJECT_SOURCE}'
    id: upload-cluster-app
  - exec:
      commandLine: 'wget -O /projects/${input:file} http://10.92.6.108:8082/packages${input:path}${input:file} -P /projects/ &&  scp -P ${input:port} /projects/${input:file} ${input:user}@${input:host}:/home/${input:user} && ssh -p ${input:port} ${input:user}@${input:host} rpm -Uvh --force --nodeps /home/${input:user}/${input:file} && echo Install rpm done, restarting app && ssh -p ${input:port} ${input:user}@${input:host} systemctl restart hmi  && echo -e "\e[32mDone.\e[0m remote-deploy"'
      component: universal-developer-image
      workingDir: '${PROJECT_SOURCE}'
    id: remote-deploy
